<!DOCTYPE html>
<html>
<head>
    <title>Admin - R√©gie Spectacle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; padding: 20px; background: #222; color: white; max-width: 800px; margin: auto; }
        .card { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        button, select, input:not([type="color"]):not([type="file"]) { width: 100%; padding: 12px; margin-top: 5px; font-size: 16px; border-radius: 5px; border: none; }
        button { background: #007bff; color: white; cursor: pointer; font-weight: bold; }
        input[type="color"] { height: 50px; padding: 0; }
        #count { float: right; color: #0f0; font-weight: bold; }
        
        /* Styles pour la Timeline */
        #audio-player { width: 100%; margin: 10px 0; }
        #events-list { max-height: 250px; overflow-y: auto; background: #1c1c1c; padding: 10px; border-radius: 5px; }
        .timeline-event { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #444; font-size: 0.9em; }
        .event-action { color: #f00; cursor: pointer; }
    </style>
</head>
<body>
    <h3>üéõÔ∏è R√©gie Spectacle <span id="count">1 connect√©</span></h3>

    <div class="card">
        <h4>üéµ S√©quence Audio & Time Code</h4>
        <input type="file" id="audioFile" accept="audio/*" onchange="loadAudio()">
        <audio id="audio-player" controls></audio>
        
        <div id="timeline-controls">
            <button onclick="startSync()" style="background:#dc3545;">üî¥ START SYNC</button>
            <p>Temps actuel: <span id="current-time">00:00.000</span></p>
        </div>
    </div>

    <div class="card">
        <h4>‚ûï Ajouter un √âv√©nement</h4>
        <input type="number" id="event-time-ms" placeholder="Temps (ms) Ex: 3500">
        
        <label for="preset-action" style="margin-top:10px; display: block;">Action Pr√©d√©finie (Gobo, Couleur unie, Effet)</label>
        <select id="preset-action">
            </select>

        <label for="gobo-filter-color" style="margin-top:10px; display: block;">Couleur du Filtre</label>
        <input type="color" id="gobo-filter-color" value="#FFFFFF">
        
        <select id="event-target">
            <option value="all">Tout le monde</option>
            <option value="Groupe A">Groupe A</option>
            <option value="Groupe B">Groupe B</option>
        </select>
        <button onclick="addEvent()">Ajouter √† la Timeline</button>
    </div>
    
    <div class="card">
        <h4>üîÅ D√©lay / Chase (Effet de Propagation A -> B)</h4>
        <select id="chase-action">
            </select>
        <input type="number" id="chase-delay-ms" value="100" placeholder="D√©lay entre les groupes (ms)">
        <button onclick="addChaseEvent()">Ajouter S√©quence D√©lay</button>
    </div>

    <div class="card">
        <h4>üï∞Ô∏è Timeline du Projet (<span id="total-events">0</span> √âv√©nements)</h4>
        <div id="events-list">
            </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let timeline = [];
        const audioPlayer = document.getElementById('audio-player');
        let syncInterval;

        // --- BIBLIOTH√àQUE DE GOBOS ET EFFETS PR√âD√âFINIS ---
        const PRESET_LIBRARY = [
            // Couleurs Unies
            { name: "Couleur Unie", type: "color", value: "use_color_input" }, 
            
            // Effets Sp√©ciaux (Type 'effect')
            { name: "Effet: Arr√™t des Effets/Retour au Noir", type: "effect", value: "OFF" },
            { name: "Effet: Strobe Rapide", type: "effect", value: "STROBE_FAST" },
            { name: "Effet: Strobe Moyen", type: "effect", value: "STROBE_MEDIUM" },
            { name: "Effet: Pulse Lent (Blanc)", type: "effect", value: "PULSE_SLOW" },
            
            // Gobos (Images - REMPLACEZ CES URLS PUBLIQUES !)
            { name: "Gobo: Logo du Groupe (URL √† remplacer)", type: "image", value: "https://votre-url-gobo-1.com/logo.png" },
            { name: "Gobo: Ciel √âtoil√© (URL √† remplacer)", type: "image", value: "https://votre-url-gobo-2.com/stars.png" },
            { name: "Gobo: Texture (URL √† remplacer)", type: "image", value: "https://votre-url-gobo-3.com/texture.png" }
        ];
        
        // Actions disponibles pour les s√©quences Chase (D√©lay)
        const CHASE_ACTIONS = PRESET_LIBRARY.filter(p => p.type !== 'image'); 
        // ----------------------------------------------------

        // Mise √† jour du compteur de connect√©s (sans l'admin)
        socket.on('update-count', (data) => {
            document.getElementById('count').innerText = (data.count - 1) + " connect√©s";
        });

        // =================================================================
        // LOGIQUE D'INTERFACE ET DE TIMELINE
        // =================================================================

        function initializePresets() {
            const select = document.getElementById('preset-action');
            select.innerHTML = '';
            PRESET_LIBRARY.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index; 
                option.innerText = item.name;
                select.appendChild(option);
            });
        }
        
        function initializeChasePresets() {
            const select = document.getElementById('chase-action');
            select.innerHTML = '';
            CHASE_ACTIONS.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index; 
                option.innerText = item.name;
                select.appendChild(option);
            });
        }

        // Ajoute l'√©v√©nement √† la timeline (dans le tableau local)
        function pushEvent(timeMs, target, type, value, color = null) {
            timeline.push({ time_ms: timeMs, target, type, value, color: color });
            timeline.sort((a, b) => a.time_ms - b.time_ms);
            renderTimeline();
        }
        
        function addEvent() {
            const timeMs = parseInt(document.getElementById('event-time-ms').value);
            const target = document.getElementById('event-target').value;
            const presetIndex = parseInt(document.getElementById('preset-action').value);
            const filterColor = document.getElementById('gobo-filter-color').value;

            if (isNaN(timeMs)) return alert("Entrez un temps en millisecondes valide.");
            
            const preset = PRESET_LIBRARY[presetIndex]; 
            let finalValue = preset.value;
            let finalColor = null;

            if (preset.type === 'color') {
                // Pour les couleurs unies, la valeur est le code couleur du filtre
                finalValue = filterColor; 
            }
            
            if (preset.type === 'image') {
                // Pour les Gobos, la couleur est pass√©e dans la propri√©t√© 'color'
                finalColor = filterColor; 
            }
            
            pushEvent(timeMs, target, preset.type, finalValue, finalColor);
        }
        
        function addChaseEvent() {
            const timeMs = parseInt(document.getElementById('event-time-ms').value);
            const delayMs = parseInt(document.getElementById('chase-delay-ms').value);
            const presetIndex = parseInt(document.getElementById('chase-action').value);
            const filterColor = document.getElementById('gobo-filter-color').value;

            if (isNaN(timeMs) || isNaN(delayMs)) return alert("Entrez des valeurs de temps valides.");
            
            const preset = CHASE_ACTIONS[presetIndex];
            
            let finalValue = preset.value;
            let finalColor = null;

            if (preset.type === 'color') {
                finalValue = filterColor; 
                finalColor = null;
            }

            // 1. √âv√©nement pour le Groupe A
            pushEvent(timeMs, "Groupe A", preset.type, finalValue, finalColor);

            // 2. √âv√©nement pour le Groupe B avec le d√©calage
            const delayedTime = timeMs + delayMs;
            pushEvent(delayedTime, "Groupe B", preset.type, finalValue, finalColor);

            alert(`S√©quence D√©lay (${delayMs}ms) ajout√©e : Groupe A √† ${timeMs}ms, Groupe B √† ${delayedTime}ms.`);
        }
        
        // Affiche la timeline sur l'interface
        function renderTimeline() {
            const list = document.getElementById('events-list');
            list.innerHTML = '';
            document.getElementById('total-events').innerText = timeline.length;

            timeline.forEach((event, index) => {
                const div = document.createElement('div');
                div.className = 'timeline-event';
                const timeStr = (event.time_ms / 1000).toFixed(3);
                
                let detail = `Type: ${event.type.toUpperCase()}, Valeur: `;
                
                if (event.type === 'color') {
                    detail += `<span style="background:${event.value}; color:${event.value==='#FFFFFF' ? '#000' : '#FFF'}; padding:2px 5px;">${event.value}</span>`;
                } else if (event.type === 'effect') {
                    detail += `**${event.value}**`;
                } else if (event.type === 'image') {
                    const colorDisplay = `<span style="background:${event.color}; color:${event.color==='#FFFFFF' ? '#000' : '#FFF'}; padding:2px 5px;">${event.color}</span>`;
                    detail += `[IMAGE] Filtr√©e par ${colorDisplay}`;
                }
                
                div.innerHTML = `
                    <span>${timeStr}s (${event.target}) : ${detail}</span>
                    <span class="event-action" onclick="removeEvent(${index})">‚ùå</span>
                `;
                list.appendChild(div);
            });
        }
        
        function removeEvent(index) {
            timeline.splice(index, 1);
            renderTimeline();
        }
        
        // Charge le fichier audio dans le lecteur
        function loadAudio() {
            const file = document.getElementById('audioFile').files[0];
            if (file) {
                audioPlayer.src = URL.createObjectURL(file);
            }
        }

        // =================================================================
        // LOGIQUE DE SYNCHRONISATION (TIME CODE)
        // =================================================================

        function startSync() {
            if (audioPlayer.paused) {
                alert("Veuillez charger et lancer la lecture de l'audio d'abord.");
                return;
            }
            if (timeline.length === 0) {
                 alert("Ajoutez des √©v√©nements √† la timeline avant de commencer.");
                return;
            }

            // 1. Envoyer la timeline aux clients
            socket.emit('timeline-load', { timeline: timeline });
            
            // 2. Lancer l'intervalle de synchronisation (toutes les 50ms)
            if (syncInterval) clearInterval(syncInterval);
            
            syncInterval = setInterval(() => {
                const currentTime = Math.round(audioPlayer.currentTime * 1000); // Temps en millisecondes
                document.getElementById('current-time').innerText = (currentTime / 1000).toFixed(3);
                
                // Envoyer le Time Code aux clients
                socket.emit('timecode-sync', { time_ms: currentTime });

                if (audioPlayer.ended) {
                    clearInterval(syncInterval);
                    console.log("Lecture termin√©e, synchronisation arr√™t√©e.");
                }
            }, 50); // Mettre √† jour toutes les 50 millisecondes
        }
        
        // Initialiser l'interface au chargement
        initializePresets();
        initializeChasePresets();
        renderTimeline();
    </script>
</body>
</html>
