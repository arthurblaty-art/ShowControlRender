<!DOCTYPE html>
<html>
<head>
    <title>CONSOLE DMX | SPECTACLE PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.js"></script>
    <style>
        /* ==================================== */
        /* BASE & LAYOUT (Inspiration Console DMX) */
        /* ==================================== */
        :root {
            --color-crowdglow: #00bcd4; /* Cyan clair (Accent principal) */
            --color-secondary: #FFC107; /* Jaune (Alertes) */
            --color-background: #0A0A0A; /* Noir profond */
            --color-card: #181818;
            --color-input: #222222;
            --color-text: #EAEAEA;
            --color-faint: #B0B0B0;
            --color-border: #333333;
            --color-red: #FF5252;
            --color-green: #4CAF50;
        }

        body { 
            font-family: 'Roboto', sans-serif; 
            padding: 15px; 
            background: var(--color-background);
            color: var(--color-text); 
            max-width: 1600px; 
            margin: auto; 
            line-height: 1.4;
        }
        h3 { 
            color: var(--color-crowdglow); 
            border-bottom: 1px solid var(--color-border); 
            padding-bottom: 10px; 
            margin-bottom: 20px; 
            font-weight: 300; 
            letter-spacing: 2px;
            font-size: 2rem;
        }
        .card { 
            background: var(--color-card); 
            padding: 15px; 
            border-radius: 4px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            border-left: 3px solid var(--accent-color, var(--color-border)); 
        }
        .card h4 { 
            color: var(--accent-color, var(--color-text)); 
            margin-top: 0; 
            font-weight: 500; 
            font-size: 1.1rem; 
            margin-bottom: 10px;
        }
        #count { float: right; color: var(--color-green); font-weight: 600; font-size: 1.1rem; }
        
        /* INPUTS & BOUTONS */
        button, select, input:not([type="color"]):not([type="file"]):not([type="range"]) { 
            width: 100%; 
            padding: 8px 10px; 
            margin-top: 5px; 
            font-size: 14px; 
            border-radius: 3px; 
            border: 1px solid var(--color-border); 
            background: var(--color-input);
            color: var(--color-text);
            box-sizing: border-box;
        }
        input[type="color"] { height: 35px; padding: 0; border-radius: 3px; cursor: pointer; border: none; }
        label { display: block; margin-top: 10px; font-size: 0.85rem; color: var(--color-faint); font-weight: 500;}
        .btn-action { 
            background: var(--btn-color, #333); 
            color: white; 
            cursor: pointer; 
            font-weight: 500; 
            border: none; 
            padding: 10px;
            transition: background 0.2s; 
        }
        .btn-action:hover { filter: brightness(1.1); }
        .btn-action:active { transform: scale(0.99); }
        
        /* FADERS (Inspiration DMX) */
        input[type="range"] {
            -webkit-appearance: none;
            height: 10px;
            background: var(--color-border);
            border-radius: 5px;
            margin-top: 8px;
            cursor: pointer;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 25px; 
            border-radius: 3px;
            background: var(--color-crowdglow);
            cursor: pointer;
            border: 1px solid #FFF;
        }
        .fader-group { 
            margin-top: 15px; 
            padding: 8px; 
            background: #121212; 
            border-radius: 4px;
        }
        .fader-group label { margin-top: 5px; }

        /* NAVIGATION PAR ONGLET */
        #tabs { display: flex; border-bottom: 2px solid var(--color-border); margin-bottom: 15px; }
        .tab-button {
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            background: var(--color-card);
            color: var(--color-faint);
            border: none;
            border-radius: 4px 4px 0 0;
            margin-right: 1px;
            font-weight: 500;
        }
        .tab-button.active {
            background: var(--color-crowdglow);
            color: var(--color-card);
            box-shadow: 0 -2px 8px rgba(0, 188, 212, 0.5);
            font-weight: 700;
        }
        
        /* DISPOSITION PRINCIPALE (CrowdGlow Broadcast App Style) */
        #Prog { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 15px; }
        #LiveSimple { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; } 


        /* LIVE CONSOLE GRID */
        #live-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px;
            margin-top: 10px;
        }
        .live-cue-button {
            height: 60px; 
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--color-text);
            background: #282828;
            border: 1px solid #505050;
        }
        .cue-status { font-size: 0.7rem; opacity: 0.7; }
        
        /* Timecode Display Large */
        #big-time-display {
            font-family: 'Roboto', monospace;
            font-size: 3rem; 
            text-align: center;
            margin: 10px 0;
            color: var(--color-secondary);
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
            padding: 15px;
            border: 1px solid var(--color-secondary);
            border-radius: 4px;
            background: #121212;
            font-weight: bold;
        }
        #current-time { font-weight: bold; font-size: 1.2rem; color: var(--color-secondary); }
        
        /* TIMELINE List */
        #events-list { max-height: 250px; overflow-y: auto; background: #121212; padding: 10px; border-radius: 4px; border: 1px solid #282828; margin-top: 15px;}
        .timeline-event { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #282828; font-size: 0.9em; align-items: center; }
        .timeline-event:last-child { border-bottom: none; }
        .time-display { font-weight: bold; width: 70px; color: var(--color-crowdglow); cursor: pointer; }
        .event-details { flex-grow: 1; margin: 0 10px; color: var(--color-faint); }
        .event-action { color: var(--color-red); cursor: pointer; font-size: 1.1em; }
    </style>
</head>
<body>
    <h3>üí° CONSOLE SPECTACLE PRO <span id="count">1 connect√©</span></h3>

    <div id="tabs">
        <button class="tab-button active" onclick="openTab(event, 'Timecode')"><i class="fas fa-wave-square"></i> TIMECODE (Timeline)</button>
        <button class="tab-button" onclick="openTab(event, 'LiveSimple')"><i class="fas fa-gamepad"></i> LIVE CONSOLE (Cues & Faders)</button>
        <button class="tab-button" onclick="openTab(event, 'Prog')"><i class="fas fa-palette"></i> PALETTE & M√âMOIRE</button>
    </div>

    <div id="Timecode" class="tab-content active">
        <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 15px;">
            <div class="card" style="--accent-color: var(--color-crowdglow);">
                <h4>üéµ Audio Timeline & Synchro</h4>
                <div id="waveform" title="Cliquez pour repositionner la t√™te de lecture."></div>
                
                <input type="file" id="audioFile" accept="audio/*" onchange="loadAudio()" title="Chargez votre fichier MP3/WAV">
                
                <div id="timeline-controls" style="display: flex; gap: 15px; margin-top: 15px;">
                    <button onclick="togglePlayback()" id="playPauseButton" class="btn-action" style="--btn-color: var(--color-green); flex: 1; padding: 15px;">
                        <i class="fas fa-play"></i> PLAY / PAUSE
                    </button>
                    <button onclick="startSync()" class="btn-action" style="--btn-color: var(--color-red); flex: 1.5; padding: 15px;">
                        <i class="fas fa-bullhorn"></i> D√âMARRER SYNCHRO
                    </button>
                </div>
                <p style="text-align: center; font-size: 0.9rem; margin-top: 10px;">Temps actuel: <strong id="current-time">00:00.000</strong></p>
                <div id="events-list"></div>
            </div>

            <div class="card" style="--accent-color: var(--color-secondary);">
                <h4>‚ú® Programmer √âv√©nement (<span id="total-events">0</span> √âv√®n.)</h4>
                
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;"><label for="event-time-ms">Snap Temps (ms) :</label><input type="number" id="event-time-ms" placeholder="Ex: 3500"></div>
                    <div style="flex: 1;"><button onclick="snapToTimecode()" class="btn-action" style="--btn-color: #5f5f5f; margin-top: 30px;">
                        <i class="fas fa-crosshairs"></i> SNAP
                    </button></div>
                </div>
                
                <div class="fader-group">
                    <label for="fade-time-ms">FADER FADE (ms) :</label>
                    <input type="number" id="fade-time-ms" value="0" placeholder="Ex: 500">
                </div>

                <label for="preset-action">PALETTE ACTION :</label>
                <select id="preset-action"></select>

                <div class="fader-group">
                    <label for="strobe-frequency">FADER STROBE (ms) :</label>
                    <div id="freq-label">
                        <span id="freq-value-timecode">100 ms</span>
                    </div>
                    <input type="range" id="strobe-frequency-timecode" min="50" max="500" value="100" oninput="updateFreqValue('timecode')">
                </div>

                <label for="gobo-filter-color">Couleur :</label>
                <input type="color" id="gobo-filter-color" value="#FFFFFF">
                
                <label for="event-target">Ciblage :</label>
                <select id="event-target"></select>
                
                <button onclick="addEvent()" class="btn-action" style="--btn-color: var(--color-secondary); margin-top: 20px;">
                    <i class="fas fa-plus"></i> Ajouter √âv√©nement
                </button>
            </div>
        </div>
        
        <div class="card" style="--accent-color: #17a2b8;">
            <h4>üîÑ S√©quence D√©lay (Chase)</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <div><label for="chase-group-1">D√©part :</label><select id="chase-group-1"></select></div>
                <div><label for="chase-group-2">Arriv√©e :</label><select id="chase-group-2"></select></div>
                <div><label for="chase-delay-ms">D√©lay (ms) :</label><input type="number" id="chase-delay-ms" value="100" placeholder="100"></div>
            </div>
            <select id="chase-action" style="margin-top: 10px;"></select>
            <button onclick="addChaseEvent()" class="btn-action" style="--btn-color: #17a2b8; margin-top: 10px;">
                <i class="fas fa-share-alt"></i> Ajouter S√©quence D√©lay
            </button>
        </div>
    </div>
    
    <div id="LiveSimple" class="tab-content">
        <div class="card" style="--accent-color: var(--color-green);">
            <h4>üéπ CUES (Triggers Rapides)</h4>
            <div id="live-grid">
                </div>
        </div>
        
        <div style="display: flex; flex-direction: column;">
            <div class="card" style="--accent-color: var(--color-secondary);">
                <h4>‚è≤Ô∏è Chronom√®tre de R√©f√©rence</h4>
                <div id="big-time-display">00:00:00</div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="startStopWatch()" class="btn-action" style="--btn-color: var(--color-green); flex: 1;"><i class="fas fa-play"></i> D√âMARRER</button>
                    <button onclick="resetStopWatch()" class="btn-action" style="--btn-color: var(--color-red); flex: 1;"><i class="fas fa-stop"></i> RESET</button>
                </div>
            </div>
            
            <div class="card" style="--accent-color: var(--color-crowdglow);">
                <h4>‚ö° Ma√Ætre Flash/Strobe (Direct)</h4>
                
                <label for="prog-action-live">ACTION FLASH :</label>
                <select id="prog-action-live"></select>
                
                <div class="fader-group">
                    <label for="strobe-frequency-prog">FADER STROBE (ms) :</label>
                    <div id="freq-label">
                        <span id="freq-value-prog">100 ms</span>
                    </div>
                    <input type="range" id="strobe-frequency-prog" min="50" max="500" value="100" oninput="updateFreqValue('prog')">
                </div>
                
                <input type="color" id="prog-color-live" value="#FFFFFF" style="margin-top: 10px;">
                
                <button onclick="previewScene(true)" class="btn-action" style="--btn-color: #5f5f5f; margin-top: 15px; padding: 15px;">
                    <i class="fas fa-hand-pointer"></i> APPLIQUER LIVE (ALL)
                </button>
            </div>
        </div>
    </div>


    <div id="Prog" class="tab-content">
            
            <div class="card" style="--accent-color: #ff7f50;">
                <h4>üî® Programmation Palette</h4>
                
                <label for="prog-action">ACTION :</label>
                <select id="prog-action"></select>
                
                <div class="fader-group">
                    <label for="prog-fade-ms">FADER FADE (ms) :</label>
                    <input type="number" id="prog-fade-ms" value="500">
                </div>
                
                <input type="color" id="prog-color" value="#FFFFFF">
                
                <label for="prog-target">Ciblage :</label>
                <select id="prog-target"></select>
                
                <button onclick="previewScene()" class="btn-action" style="--btn-color: #5f5f5f; margin-top: 15px;">
                    <i class="fas fa-eye"></i> Aper√ßu sur Cible
                </button>
                
                <hr style="border-top: 1px dashed var(--color-border); margin: 20px 0;">
                
                <label for="cue-name">Nom du CUE (M√©moire) :</label>
                <input type="text" id="cue-name" placeholder="Ex: R√©frain Bleu Strobe">
                
                <button onclick="saveSceneAsCue()" class="btn-action" style="--btn-color: #ff7f50; margin-top: 8px;">
                    <i class="fas fa-save"></i> Enregistrer CUE
                </button>
            </div>
            
            <div class="card" style="--accent-color: var(--color-crowdglow);">
                <h4>üñºÔ∏è Gobo Designer (Dessin & Upload)</h4>
                
                <canvas id="gobo-canvas" width="250" height="250"></canvas>
                
                <div class="draw-controls">
                    <input type="color" id="draw-color" value="#FFFFFF" style="height: 35px;">
                    <select id="draw-mode">
                        <option value="line">Ligne</option>
                        <option value="rect">Carr√©</option>
                        <option value="circle">Cercle</option>
                    </select>
                    <button onclick="clearCanvas()" class="btn-action" style="--btn-color: var(--color-red); padding: 5px;"><i class="fas fa-eraser"></i> Clear</button>
                </div>
                
                <button onclick="createGoboFromCanvas()" class="btn-action" style="--btn-color: var(--color-crowdglow); margin-top: 10px;">
                    <i class="fas fa-paint-brush"></i> Cr√©er Gobo
                </button>
                
                <hr style="border-top: 1px dashed var(--color-border); margin: 20px 0;">

                <input type="file" id="gobo-upload" accept="image/*">
                <button onclick="uploadGobo()" class="btn-action" style="--btn-color: #444; margin-top: 8px;">
                    <i class="fas fa-upload"></i> Uploader Gobo
                </button>
                <p id="upload-status" style="font-size: 0.85em; margin-top: 5px; color: var(--color-secondary);"></p>
            </div>
            
            <div class="card" style="--accent-color: #999;">
                <h4>üë• Gestion des Adresses (Groupes)</h4>
                <input type="text" id="new-group-name" placeholder="Nom du nouveau groupe (Ex: Zone C)">
                <button onclick="addGroup()" class="btn-action" style="--btn-color: #999;">
                    <i class="fas fa-plus-circle"></i> Ajouter Adresse
                </button>
                <div id="group-buttons" style="margin-top: 20px;"></div>
                <hr style="border-top: 1px dashed var(--color-border); margin: 20px 0;">
                <h5>Actions Rapides:</h5>
                <p style="font-size: 0.85em; color: var(--color-faint);">Cliquer sur un groupe pour lui envoyer la palette en cours.</p>
            </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let timeline = [];
        let syncInterval;
        let wavesurfer = null; 
        let availableGroups = ['all', 'Groupe A', 'Groupe B']; 
        let scenes = {}; 
        let lastSnappedTime = 0; 
        
        // Chronom√®tre Live Variables
        let stopwatchInterval;
        let startTime = 0;
        let elapsedTime = 0;

        // Gobo Drawing Variables
        const canvas = document.getElementById('gobo-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let startX, startY;
        
        // PRESETS AVEC ICONES ET COULEURS POUR L'INTERFACE
        const PRESET_LIBRARY = [
            { name: "Couleur Unie", type: "color", value: "use_color_input", icon: "fas fa-palette" }, 
            { name: "Effet: Arr√™t (Noir)", type: "effect", value: "OFF", icon: "fas fa-power-off", bgColor: "#111" },
            { name: "Effet: Strobe Rapide", type: "effect", value: "STROBE_FAST", icon: "fas fa-bolt", bgColor: "#FFC107" },
            { name: "Effet: Strobe Moyen", type: "effect", value: "STROBE_MEDIUM", icon: "fas fa-bolt", bgColor: "#FF9800" },
            { name: "Effet: Strobe RND", type: "effect", value: "STROBE_RND", icon: "fas fa-random", bgColor: "#E91E63" }, 
            { name: "Effet: Pulse Lent", type: "effect", value: "PULSE_SLOW", icon: "fas fa-heartbeat", bgColor: "#00E676" },
            { name: "Gobo: Logo (Exemple)", type: "image", value: "https://via.placeholder.com/200?text=LOGO", icon: "fas fa-image" },
        ];


        // =================================================================
        // PARTIE 1: NAVIGUATION & INITIALISATION
        // =================================================================
        
        function updateFreqValue(prefix) {
            const value = document.getElementById(`strobe-frequency-${prefix}`).value;
            document.getElementById(`freq-value-${prefix}`).innerText = `${value} ms`;
        }
        
        document.addEventListener("DOMContentLoaded", () => {
             updateFreqValue('timecode');
             updateFreqValue('prog');
             document.getElementById('Timecode').style.display = "block"; 
             initCanvas();
             initializePresets();
             updateGroupSelectors();
        });

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            const displayStyle = (tabName === 'Prog') ? 'grid' : (tabName === 'LiveSimple' ? 'grid' : 'block'); 
            document.getElementById(tabName).style.display = displayStyle;
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
            
            if (tabName === 'Timecode' && wavesurfer) wavesurfer.drawBuffer();
            if (tabName === 'LiveSimple') renderLiveButtons(); 
        }
        

        function initializePresets() {
            const selectors = [document.getElementById('preset-action'), document.getElementById('prog-action'), document.getElementById('prog-action-live')];
            const chaseSelect = document.getElementById('chase-action');
            
            selectors.forEach(select => {
                select.innerHTML = '';
                PRESET_LIBRARY.forEach((item, index) => {
                    select.add(new Option(item.name, index));
                });
            });
            
            chaseSelect.innerHTML = '';
            PRESET_LIBRARY.filter(p => p.type !== 'image').forEach((item, index) => {
                 chaseSelect.add(new Option(item.name, index));
            });
            
            // Pr√©-s√©lectionner un effet (Strobe) pour la console LIVE par d√©faut
            const strobePreset = PRESET_LIBRARY.findIndex(p => p.value === 'STROBE_FAST');
            if (strobePreset !== -1) {
                document.getElementById('prog-action-live').value = strobePreset;
            }
        }
        
        socket.on('update-count', (data) => { document.getElementById('count').innerText = (data.count - 1) + " connect√©s"; });
        socket.on('connect', () => { updateGroupSelectors(); initializePresets(); });


        // =================================================================
        // PARTIE 2: WAVESURFER & TIMECODE (Timeline)
        // =================================================================
        
        function initWavesurfer() {
            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: '#444444', 
                progressColor: '#00bcd4', 
                cursorColor: '#FF5252', 
                barWidth: 2,
                height: 100,
                responsive: true,
                backend: 'MediaElement',
                dragToSeek: true 
            });
            
            wavesurfer.on('audioprocess', function () {
                const currentTime = Math.round(wavesurfer.getCurrentTime() * 1000);
                document.getElementById('current-time').innerText = (currentTime / 1000).toFixed(3);
                lastSnappedTime = currentTime; 
            });
             
            wavesurfer.on('seek', (progress) => {
                const seekTimeMs = Math.round(progress * wavesurfer.getDuration() * 1000);
                snapToTimecode(seekTimeMs);
            });

            wavesurfer.on('play', () => { 
                document.getElementById('playPauseButton').innerHTML = '<i class="fas fa-pause"></i> PAUSE'; 
                document.getElementById('playPauseButton').style.setProperty('--btn-color', '#FF5252');
            });
            wavesurfer.on('pause', () => { 
                document.getElementById('playPauseButton').innerHTML = '<i class="fas fa-play"></i> PLAY'; 
                document.getElementById('playPauseButton').style.setProperty('--btn-color', '#4CAF50');
            });
            
            wavesurfer.on('ready', () => { renderTimeline(); });
        }

        async function loadAudio() {
            const fileInput = document.getElementById('audioFile');
            const file = fileInput.files[0];

            if (file) { 
                if(!wavesurfer) initWavesurfer(); 
                
                const formData = new FormData();
                formData.append('audioFile', file);

                try {
                    const response = await fetch('/upload-audio', { 
                        method: 'POST', 
                        body: formData 
                    });
                    const data = await response.json();

                    if (data.success) {
                        wavesurfer.load(data.url); 
                        console.log(`Audio charg√© depuis : ${data.url}`);
                    } else {
                        alert(`Erreur d'upload: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Erreur lors du t√©l√©chargement de l\'audio:', error);
                    alert("Erreur de connexion au serveur pour l'upload. V√©rifiez que 'multer' est install√© et configur√© dans server.js.");
                }
            }
        }
        
        function togglePlayback() {
            if (wavesurfer && wavesurfer.isReady) { wavesurfer.playPause(); } else { alert("Veuillez charger une piste audio d'abord."); }
        }
        
        function snapToTimecode(timeMs = lastSnappedTime) {
            document.getElementById('event-time-ms').value = timeMs;
        }

        function startSync() {
            if (!wavesurfer || !wavesurfer.isReady) { alert("Veuillez charger l'audio."); return; }
            if (timeline.length === 0) { alert("Ajoutez des √©v√©nements √† la timeline."); return; }

            socket.emit('timeline-load', { timeline: timeline });
            
            if (syncInterval) clearInterval(syncInterval);
            
            syncInterval = setInterval(() => {
                const currentTime = Math.round(wavesurfer.getCurrentTime() * 1000); 
                socket.emit('timecode-sync', { time_ms: currentTime });

                if (wavesurfer.getDuration() * 1000 <= currentTime && !wavesurfer.isPlaying()) {
                    clearInterval(syncInterval);
                }
            }, 50); 
            
            alert("Synchronisation Timecode lanc√©e !");
        }
        
        function pushEvent(timeMs, target, type, value, color = null, fade_ms = 0, frequency_ms = 0) {
            timeline.push({ time_ms: timeMs, target, type, value, color: color, fade_ms: fade_ms, frequency_ms: frequency_ms });
            timeline.sort((a, b) => a.time_ms - b.time_ms);
            renderTimeline();
        }
        
        function addEvent() {
            const timeMs = parseInt(document.getElementById('event-time-ms').value);
            const target = document.getElementById('event-target').value;
            const presetIndex = parseInt(document.getElementById('preset-action').value);
            const filterColor = document.getElementById('gobo-filter-color').value;
            const fadeMs = parseInt(document.getElementById('fade-time-ms').value) || 0; 
            const frequencyMs = parseInt(document.getElementById('strobe-frequency-timecode').value) || 0; 

            if (isNaN(timeMs)) return alert("Entrez un temps en millisecondes valide.");
            
            const preset = PRESET_LIBRARY[presetIndex]; 
            let finalValue = preset.value;
            let finalColor = null;

            if (preset.type === 'color' || preset.type === 'effect') { finalValue = filterColor; }
            if (preset.type === 'image') { finalColor = filterColor; }
            
            pushEvent(timeMs, target, preset.type, finalValue, finalColor, fadeMs, frequencyMs);
        }

        function addChaseEvent() {
            const timeMs = parseInt(document.getElementById('event-time-ms').value);
            const delayMs = parseInt(document.getElementById('chase-delay-ms').value);
            const presetIndex = parseInt(document.getElementById('chase-action').value);
            const filterColor = document.getElementById('gobo-filter-color').value;
            const fadeMs = parseInt(document.getElementById('fade-time-ms').value) || 0; 
            const frequencyMs = parseInt(document.getElementById('strobe-frequency-timecode').value) || 0; 
            const target1 = document.getElementById('chase-group-1').value; 
            const target2 = document.getElementById('chase-group-2').value; 

            if (isNaN(timeMs) || isNaN(delayMs)) return alert("Entrez des valeurs de temps valides.");
            if (target1 === target2) return alert("Les groupes de d√©part et d'arriv√©e doivent √™tre diff√©rents pour un effet Chase.");
            
            const preset = PRESET_LIBRARY[presetIndex];
            let finalValue = preset.value;
            let finalColor = null;

            if (preset.type === 'color' || preset.type === 'effect') { finalValue = filterColor; }
            if (preset.type === 'image') { finalColor = filterColor; }
            
            pushEvent(timeMs, target1, preset.type, finalValue, finalColor, fadeMs, frequencyMs);
            pushEvent(timeMs + delayMs, target2, preset.type, finalValue, finalColor, fadeMs, frequencyMs);

            alert(`S√©quence D√©lay (${delayMs}ms) ajout√©e.`);
        }
        
        function removeEvent(index) {
            timeline.splice(index, 1);
            renderTimeline();
        }

        function renderTimeline() {
            const list = document.getElementById('events-list');
            list.innerHTML = '';
            document.getElementById('total-events').innerText = timeline.length;
            
            if (wavesurfer) wavesurfer.clearMarkers();

            timeline.forEach((event, index) => {
                const timeStr = (event.time_ms / 1000).toFixed(3);
                let markerColor = '#AAAAAA'; 
                let details = '';
                
                if (event.type === 'color' || event.type === 'effect') {
                    const colorDisplay = `<span style="color:${event.color}; font-weight: bold;">${event.type.toUpperCase()}</span>`;
                    
                    details = colorDisplay;
                    if (event.value.startsWith('STROBE')) { 
                         let strobeType = (event.value === 'STROBE_RND') ? 'RND' : 'R√âGULIER';
                         details = `STROBE (${strobeType}: ${event.frequency_ms}ms) sur ${event.color}`;
                    }
                    
                    markerColor = event.color;
                } else if (event.type === 'image') {
                    const goboName = PRESET_LIBRARY.find(p => p.value === event.value)?.name || 'Gobo Custom';
                    details = `GOBO: ${goboName.split(':').pop().trim()}`;
                    markerColor = event.color;
                }
                
                const div = document.createElement('div');
                div.className = 'timeline-event';
                div.innerHTML = `
                    <span class="time-display" onclick="wavesurfer.seekTo(${event.time_ms / 1000 / wavesurfer.getDuration()})">${timeStr}s</span>
                    <span class="event-details">
                        <i class="fas fa-users" style="color:#B0B0B0;"></i> ${event.target} | 
                        ${details}
                    </span>
                    <span class="event-action" onclick="removeEvent(${index})"><i class="fas fa-trash-alt"></i></span>
                `;
                list.appendChild(div);

                if (wavesurfer && wavesurfer.isReady) {
                    wavesurfer.addMarker({
                        time: event.time_ms / 1000,
                        label: `${event.target.substring(0, 1)}`,
                        color: markerColor,
                        position: 'top', 
                        tooltip: `${timeStr}s - ${event.target}`
                    });
                }
            });
        }
        
        // =================================================================
        // PARTIE 3: LIVE SIMPLE (Chronom√®tre)
        // =================================================================
        
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = Math.floor((ms % 1000) / 10); 
            
            const pad = (num, digits = 2) => num.toString().padStart(digits, '0');
            
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}.${pad(milliseconds)}`;
        }

        function updateStopWatch() {
            elapsedTime = Date.now() - startTime;
            document.getElementById('big-time-display').innerText = formatTime(elapsedTime);
        }

        function startStopWatch() {
            if (stopwatchInterval) return; 
            
            if (startTime === 0) { 
                startTime = Date.now();
            } else { 
                 startTime = Date.now() - elapsedTime;
            }
            
            stopwatchInterval = setInterval(updateStopWatch, 10);
            document.querySelector('#LiveSimple .card:nth-child(2) .btn-action:first-child').innerHTML = '<i class="fas fa-pause"></i> PAUSE';
            document.querySelector('#LiveSimple .card:nth-child(2) .btn-action:first-child').onclick = pauseStopWatch;

        }

        function pauseStopWatch() {
            clearInterval(stopwatchInterval);
            stopwatchInterval = null;
            document.querySelector('#LiveSimple .card:nth-child(2) .btn-action:first-child').innerHTML = '<i class="fas fa-play"></i> REPRENDRE';
            document.querySelector('#LiveSimple .card:nth-child(2) .btn-action:first-child').onclick = startStopWatch;

        }

        function resetStopWatch() {
            clearInterval(stopwatchInterval);
            stopwatchInterval = null;
            startTime = 0;
            elapsedTime = 0;
            document.getElementById('big-time-display').innerText = formatTime(0);
            document.querySelector('#LiveSimple .card:nth-child(2) .btn-action:first-child').innerHTML = '<i class="fas fa-play"></i> D√âMARRER';
            document.querySelector('#LiveSimple .card:nth-child(2) .btn-action:first-child').onclick = startStopWatch;
        }
        
        // =================================================================
        // PARTIE 4: PROG & GROUPES
        // =================================================================
        
        function updateGroupSelectors() {
            const selectors = [document.getElementById('event-target'), document.getElementById('chase-group-1'), document.getElementById('chase-group-2'), document.getElementById('prog-target')];
            selectors.forEach(s => s.innerHTML = '');
            
            availableGroups.filter(g => g !== 'all').forEach(group => {
                selectors[1].add(new Option(group, group));
                selectors[2].add(new Option(group, group));
            });

            availableGroups.forEach(group => {
                selectors[0].add(new Option(group, group));
                selectors[3].add(new Option(group, group));
            });
            renderGroupButtons();
        }

        function addGroup() {
            const name = document.getElementById('new-group-name').value.trim();
            if (name && !availableGroups.includes(name)) {
                availableGroups.push(name);
                document.getElementById('new-group-name').value = '';
                updateGroupSelectors();
            } else if (name) {
                alert("Cette adresse/groupe existe d√©j√†.");
            }
        }
        
        function renderGroupButtons() {
            const container = document.getElementById('group-buttons');
            container.innerHTML = '';
            availableGroups.filter(g => g !== 'all').forEach(group => {
                const btn = document.createElement('button');
                btn.className = 'client-item btn-action'; 
                btn.innerText = group;
                btn.style.setProperty('--btn-color', '#00bcd4');
                btn.onclick = () => quickSendToGroup(group);
                container.appendChild(btn);
            });
        }

        function getProgData(isLive = false) {
            const actionId = isLive ? 'prog-action-live' : 'prog-action';
            const colorId = isLive ? 'prog-color-live' : 'prog-color';
            const target = isLive ? 'all' : document.getElementById('prog-target').value;
            
            // Faders de Fade et Strobe
            const fadeMs = parseInt(document.getElementById('prog-fade-ms').value) || 0; 
            const frequencyMs = parseInt(document.getElementById('strobe-frequency-prog').value) || 0; 
            
            const presetIndex = parseInt(document.getElementById(actionId).value);
            const color = document.getElementById(colorId).value;
            
            const preset = PRESET_LIBRARY[presetIndex]; 
            let finalValue = preset.value;
            let finalColor = null;

            if (preset.type === 'color' || preset.type === 'effect') { finalValue = color; }
            if (preset.type === 'image') { finalColor = color; }

            return { target, type: preset.type, value: finalValue, color: finalColor, fade_ms: fadeMs, frequency_ms: frequencyMs }; 
        }

        function previewScene(isLive = false) {
            const data = getProgData(isLive);
            socket.emit("admin-order", data); 
        }

        function saveSceneAsCue() {
            const cueName = document.getElementById('cue-name').value.trim();
            if (!cueName) return alert("Veuillez donner un nom au CUE.");
            
            const data = getProgData();
            scenes[cueName] = data; 
            document.getElementById('cue-name').value = '';
            
            alert(`Sc√®ne "${cueName}" enregistr√©e en CUE !`);
            
            if (document.getElementById('LiveSimple').classList.contains('active')) {
                renderLiveButtons();
            }
        }
        
        function quickSendToGroup(group) {
            const data = getProgData();
            data.target = group;
            socket.emit("admin-order", data);
        }
        
        // =================================================================
        // PARTIE 5: GOBOS DESIGNER (DESSIN & UPLOAD)
        // =================================================================

        function initCanvas() {
            ctx.fillStyle = '#121212';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#FFFFFF'; 
            ctx.lineWidth = 2;
            ctx.font = '30px Roboto';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#444';
            ctx.fillText("Draw Here", canvas.width / 2, canvas.height / 2);
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            const pos = getMousePos(e);
            startX = pos.x;
            startY = pos.y;
            ctx.strokeStyle = document.getElementById('draw-color').value;
            ctx.lineWidth = 4;
            if (document.getElementById('draw-mode').value === 'line') {
                 ctx.beginPath();
                 ctx.moveTo(startX, startY);
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const pos = getMousePos(e);
            const mode = document.getElementById('draw-mode').value;
            
            if (mode === 'line') {
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (!isDrawing) return;
            isDrawing = false;
            const pos = getMousePos(e);
            const mode = document.getElementById('draw-mode').value;
            
            if (mode !== 'line') {
                const width = pos.x - startX;
                const height = pos.y - startY;
                
                ctx.beginPath();
                if (mode === 'rect') {
                    ctx.rect(startX, startY, width, height);
                    ctx.stroke();
                } else if (mode === 'circle') {
                    const radius = Math.sqrt(width * width + height * height) / 2;
                    ctx.arc(startX + width/2, startY + height/2, radius, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
        });
        
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            initCanvas(); 
        }

        function createGoboFromCanvas() {
            const goboName = prompt("Nommez votre nouveau Gobo :");
            if (!goboName) return;

            const dataUrl = canvas.toDataURL('image/png');
            
            const newPreset = {
                name: `Gobo Dessin√©: ${goboName}`,
                type: "image",
                value: dataUrl,
                icon: "fas fa-image"
            };
            PRESET_LIBRARY.push(newPreset);
            
            initializePresets(); 
            alert(`‚úÖ Gobo "${goboName}" cr√©√© et ajout√© aux Palettes !`);
        }
        
        async function uploadGobo() {
            const fileInput = document.getElementById('gobo-upload');
            const status = document.getElementById('upload-status');
            const file = fileInput.files[0];

            if (!file) { status.innerText = "Veuillez s√©lectionner un fichier."; return; }
            status.innerText = "T√©l√©chargement en cours...";
            
            const formData = new FormData();
            formData.append('goboFile', file);

            try {
                // NOTE: Vous devez avoir un endpoint '/upload-gobo' dans votre server.js
                const response = await fetch('/upload-gobo', { method: 'POST', body: formData }); 
                const data = await response.json();

                if (data.success) {
                    const newPreset = {
                        name: `Gobo Upload: ${file.name.substring(0, 20)}`,
                        type: "image",
                        value: data.url,
                        icon: "fas fa-image"
                    };
                    PRESET_LIBRARY.push(newPreset);
                    initializePresets(); 
                    status.innerText = `‚úÖ Gobo ${file.name} ajout√© !`;
                } else {
                    status.innerText = `‚ùå Erreur : ${data.message || 'Probl√®me serveur.'}`;
                }
            } catch (error) {
                status.innerText = `‚ùå Erreur de connexion: ${error.message}`;
            }
        }


        // =================================================================
        // PARTIE 6: MODE LIVE (Manuel) - Cues (Esth√©tique Palette)
        // =================================================================
        
        // Utilit√© pour v√©rifier si une couleur est claire (pour choisir la couleur du texte)
        function isColorLight(hex) {
            if (hex.startsWith('use_')) return false; 
            const color = hex.substring(1); 
            const r = parseInt(color.substring(0, 2), 16);
            const g = parseInt(color.substring(2, 4), 16);
            const b = parseInt(color.substring(4, 6), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return yiq >= 128; 
        }


        function renderLiveButtons() {
            const grid = document.getElementById('live-grid');
            grid.innerHTML = '';
            
            const cueNames = Object.keys(scenes).sort();
            
            if (cueNames.length === 0) {
                grid.innerHTML = `<p style="color: var(--color-secondary); grid-column: 1 / -1; text-align: center; padding: 20px;">
                    Aucun CUE enregistr√©. Enregistrez des palettes dans l'onglet PALETTE & M√âMOIRE !
                </p>`;
                return;
            }

            cueNames.forEach(name => {
                const cue = scenes[name];
                const btn = document.createElement('button');
                btn.className = 'live-cue-button btn-action';
                
                let bgColor = (cue.type === 'color' || cue.type === 'effect') ? cue.value : (cue.color || '#333');
                
                // Styles sp√©cifiques pour les effets Strobes/Pulse
                if (cue.value.startsWith('STROBE') || cue.value === 'PULSE_SLOW') {
                    const presetData = PRESET_LIBRARY.find(p => p.value === cue.value);
                    bgColor = presetData?.bgColor || cue.color || '#FFC107'; 
                }

                // Si la couleur est noire/OFF, utiliser un gris fonc√© pour contraste
                if (bgColor.toLowerCase() === '#000000' || bgColor.toLowerCase() === 'off') {
                    bgColor = '#181818';
                }
                
                btn.style.setProperty('--btn-color', bgColor);
                
                // Choisir la couleur du texte (Noir si fond clair, Blanc si fond fonc√©)
                const isLight = isColorLight(bgColor);
                btn.style.color = isLight ? '#121212' : 'white';
                
                // Construction du contenu
                let iconClass = 'fas fa-lightbulb'; 
                let statusText = `${cue.target}`;

                const presetFound = PRESET_LIBRARY.find(p => p.type === cue.type && (p.value === cue.value || p.type === 'color'));
                if (presetFound) iconClass = presetFound.icon || 'fas fa-lightbulb';

                if (cue.value.startsWith('STROBE')) {
                     statusText = `Strobe ${cue.frequency_ms}ms | ${cue.target}`;
                     iconClass = 'fas fa-bolt';
                } else if (cue.type === 'color' || cue.type === 'effect') {
                     statusText = `Couleur | ${cue.fade_ms}ms | ${cue.target}`;
                } else if (cue.type === 'image') {
                     statusText = `Gobo | ${cue.target}`;
                     iconClass = 'fas fa-image';
                }


                btn.innerHTML = `
                    <i class="${iconClass}" style="margin-right: 5px;"></i>
                    ${name.toUpperCase()}
                    <div class="cue-status">
                        ${statusText}
                    </div>
                `;
                btn.onclick = () => triggerCue(name);
                grid.appendChild(btn);
            });
        }
        
        function triggerCue(cueName) {
            const data = scenes[cueName];
            if (!data) return;
            
            socket.emit("admin-order", data);
            
            console.log(`CUE LIVE d√©clench√© : ${cueName}`);
        }

    </script>
</body>
</html>
